import os
import sys
import json
from typing import List, Dict, Optional
import logging
import pymupdf.layout
import pymupdf4llm
import clip
import torch
from pathlib import Path
from pix2tex.cli import LatexOCR
from PIL import Image
from langchain_core.documents import Document
from langchain_text_splitters import MarkdownHeaderTextSplitter


class DocumentLoader:
    def __init__(self):
        self.supported_extensions = ['.pdf']  # We'll add more later
        self.logger = logging.getLogger(__name__)
        self.device = "cuda" if torch.cuda.is_available() else "cpu"
        self.clipModel, self.preprocess = clip.load("ViT-B/32", device=self.device)
        self.labels = ["a mathematical equation", "a diagram", "a table", "a chart", "a plot", "a graph", "a figure"]
        self.OCRModel = LatexOCR()
        self.markdown_splitter = MarkdownHeaderTextSplitter(headers_to_split_on=("#", "Header 1"), strip_headers=False)
    
    def load_directory(self, directory_path: str) -> List[Dict]:
        """Load all supported documents from a directory"""
        documents = []
        
        if not os.path.isdir(directory_path):
            self.logger.warning(f"Directory not found: {directory_path}")
            return documents
        
        for filename in os.listdir(directory_path):
            file_path = os.path.join(directory_path, filename)
            
            # Skip directories
            if os.path.isdir(file_path):
                continue
            
            # Check if file extension is supported
            ext = self._get_file_extension(filename)
            if ext not in self.supported_extensions:
                self.logger.debug(f"Skipping unsupported file: {filename}")
                continue
            
            # Load the file based on extension
            try:
                if ext == '.pdf':
                    content = self._load_pdf(str(file_path))
                    images = self.get_png_files(directory_path)

                    for image in images:
                        img = Image.open(image)
                        image_input = self.preprocess(img).unsqueeze(0).to(self.device)
                        text_inputs = clip.tokenize(self.labels).to(self.device)
                        

                        with torch.no_grad():
                            image_features = self.clipModel.encode_image(image_input)
                            text_features = self.clipModel.encode_text(text_inputs)
                            similarity = (image_features @ text_features.T).softmax(dim=-1)

                        is_math = similarity[0][0] > 0.5 
                        if is_math:
                            try:
                                equation = self.OCRModel(img)
                                content = content.replace('![](' + str(image) + ')', equation)
                            except ValueError as e:
                                print(f"OCR failed for {image}: {e}, skipping")
                                continue

                    self.delete_png_files(directory_path)
                    if content:
                        print("Document appended")
                        documents.append({
                            'filename': filename,
                            'file_path': file_path,
                            'course': os.path.basename(directory_path),
                            'extension': ext,
                            'content': content
                        })
                # Add more file type handlers here as needed
            except Exception as e:
                self.logger.error(f"Error loading file {filename}: {str(e)}")
                import traceback
                traceback.print_exc()
                continue
        
        return documents

    def convert_to_langDoc(self,documents):
        langDocs = []
        for doc in documents:
            chunks = self.markdown_splitter.split_text(doc[0]['content'])
            for i, chunk in enumerate(chunks):
                langDocs.append(Document(
                    page_content=chunk.page_content, 
                    metadata={
                        'source': doc['file_path'],
                        'course': doc['course'],
                        'header': chunk.metadata.get("Header 1", ""),
                        'chunk_number': i
                        }
                    )
                )
        return langDocs
    
    def _load_pdf(self, file_path: str) -> Optional[str]:
        """Extract text from a PDF file"""
        extraction = pymupdf4llm.to_markdown(
            file_path,                 
            write_images=True,            # actually write image files
            image_format="png",           
            header=False,            
            footer=False,               
            use_ocr=True,                 # let layout/OCR help if needed
            show_progress=False,
        )
        return extraction

    def get_png_files(self, directory_path: str) -> List[str]:
        """Get a list of all PNG files in a directory (non-recursive)"""
        png_files = []
        
        if not os.path.isdir(directory_path):
            return png_files
        
        for filename in os.listdir(directory_path):
            file_path = os.path.join(directory_path, filename)
            
            # Skip directories
            if os.path.isdir(file_path):
                continue
            
            # Check if file is a PNG
            if filename.lower().endswith('.png'):
                png_files.append(file_path)
        
        return png_files

    def delete_png_files(self, directory_path: str, recursive: bool = True):
        directory = Path(directory_path)
        
        if recursive:
            png_files = directory.rglob("*.png")
        else:
            png_files = directory.glob("*.png")
        
        for png_file in png_files:
            try:
                png_file.unlink()  # Delete the file
            except Exception as e:
                print(f"Error deleting {png_file}: {e}")
    
    def _get_file_extension(self, filename: str) -> str:
        """Helper to get lowercase file extension"""
        _, ext = os.path.splitext(filename)
        return ext.lower()


def main():
    """Load documents from a directory and save the extracted content"""
    logging.basicConfig(level=logging.INFO)
    
    # Get directory path from command line argument
    if len(sys.argv) > 1:
        directory_path = sys.argv[1]
    else:
        print("Usage: python document_loader.py <path_to_directory>")
        sys.exit(1)
    
    # Validate directory exists
    if not os.path.isdir(directory_path):
        print(f"Error: Directory not found: {directory_path}")
        sys.exit(1)
    
    # Create loader and load directories
    loader = DocumentLoader()
    subdirs = [d for d in os.listdir(directory_path) if os.path.isdir(os.path.join(directory_path, d))]

    for dir in subdirs:
        print(f"Loading documents from: {dir}")
        documents = loader.load_directory(dir)
        
        if not documents:
            print("No documents were loaded.")
            sys.exit(1)
        
        # Create outputs directory if it doesn't exist
        outputs_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), "outputs")
        os.makedirs(outputs_dir, exist_ok=True)
        
        # Save output for each document
        for doc in documents:
            # Generate output filename
            base_name = os.path.splitext(doc['filename'])[0]
            output_path = os.path.join(outputs_dir, f"{base_name}_extracted.md")
            
            # Save output
            content = doc['content']
            if isinstance(content, str):
                try:
                    # Try to parse it to ensure it's valid JSON, then write formatted
                    parsed = json.loads(content)
                    with open(output_path, 'w', encoding='utf-8') as f:
                        json.dump(parsed, f, indent=2, ensure_ascii=False)
                except json.JSONDecodeError:
                    # If it's not valid JSON, write as plain text
                    with open(output_path, 'w', encoding='utf-8') as f:
                        f.write(content)
            else:
                # If it's a dict or other object, convert to JSON
                with open(output_path, 'w', encoding='utf-8') as f:
                    json.dump(content, f, indent=2, ensure_ascii=False)
            
            print(f"Output saved to: {output_path}")
        
        print(f"\nSuccessfully processed {len(documents)} document(s) for {dir}")


if __name__ == "__main__":
    main()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              